<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="pouchdb.html">
<link rel="import" href="shopping-list-model.html">

<dom-module id="shopping-list-item-add">
  <template>
    <style>
      :host {
        display: block;
        padding: 8px 8px;
      }

      paper-card {
        width: 100%;
        padding: 8px;
      }
    </style>

    <iron-location id="ironLocation"></iron-location>

    <paper-card heading="New List Item">
      <iron-form id="listItemAddForm">
        <input id="id" name="id" type="hidden" value="[[listItemId]]"></input>
        <paper-input id="title" name="title" label="Title" value="{{title}}" required autofocus></paper-input>
        <paper-button on-click="_submit" id="listItemAddFormSubmit" raised>Save</paper-button>
      </iron-form>
    </paper-card>

  </template>
  <script>

    class ShoppingListItemAdd extends Polymer.Element {

      static get is() { return "shopping-list-item-add"; }

      static get observers() {
        return [
          "_routeChanged(route.*)"
        ]
      }

      static get properties() {
        return {
          shoppingListFactory: {
            type: Object,
            readOnly: true,
            notify: false,
            value: function() {
              return new ShoppingListModel.ShoppingListFactory();
            }
          },
          db: {
            type: Object,
            readOnly: true,
            notify: false,
            value: function() {
              return new PouchDB("shopping-list", { storage: "persistent" });
            }
          },
          shoppingListRepository: {
            type: Object,
            readOnly: true,
            notify: false,
            value: function() {
              return new ShoppingListModel.ShoppingListRepositoryPouchDB(this.db);
            }
          },
          listItemId: {
            type: String,
            readOnly: true,
            notify: true
          },
          title: {
            type: String,
            notify: true
          }
        };
      }

      _routeChanged(route) {
        if (route.base.prefix !== "/item-add") {
          return;
        }
        this._setListItemId(route.base.path.replace(/\//g, ""));
      }

      _submit() {
        this.shoppingListRepository.get(this.listItemId).then(shoppingList => {
          let shoppingListItem = this.shoppingListFactory.newShoppingListItem({
            title: this.title
          }, shoppingList);
          return this.shoppingListRepository.putItem(shoppingListItem);
        }).then(shoppingListItem => {
          this.$.listItemAddForm.reset();
          this.title = undefined;
          this.$.ironLocation.path = this.rootPath + "items/"+ this.listItemId;
        });
      }

    }
    window.customElements.define(ShoppingListItemAdd.is, ShoppingListItemAdd);
  </script>
</dom-module>
